---
layout: post
title: Android性能调优之我见.md
date: 2013-7-23
tag: Android技术
---             

<h2>前言</h2>
本文主要分享自己在开发项目中的遇到的可以性能调优的地方，包括同步改异步、缓存、Layout优化、数据库优化、算法优化、延迟执行等。
           
<h2>性能调试及定位</h2>
主要使用Traceview、monkey、monkey runner调试，traceview类似java web调优的visualvm，使用方法如下：

在需要调优的activity onCreate函数中添加
```
android.os.debug.startMethodTracing("Entertainment");
```
onDestrory函数中添加
```
android.os.debug.stopMethodTracing();
```
程序退出后会在sd卡根目录下生成Entertainment.trace这个文件，cmd到android sdk的tools目录下运行traceview.bat Entertainment.trace即可，可以从结果中看出各个函数的调用时间、调用次数、平均调用时间、时间占用百分比等从而定位到耗时的操作。
<h2>性能调优点</h2>
主要包括同步改异步、缓存、Layout优化、数据库优化、算法优化、延迟执行。
<h3>同步改异步</h3>
这个就不用多讲了，耗时操作放在线程中执行防止占用主线程，一定程度上解决anr。但需要注意线程和service结合（防止activity被回收后线程也被回收）以及线程的数量，线程池使用可见java的线程池
<h3>缓存</h3>
java的对象创建需要分配资源较耗费时间，加上创建的对象越多会造成越频繁的gc影响系统响应。主要使用单例模式、缓存(图片缓存、线程池、View缓存、IO缓存、消息缓存、通知栏notification缓存)及其他方式减少对象创建。
- 单例模式

对于创建开销较大的类可使用此方法，保证全局一个实例，在程序运行过程中该类不会因新建额外对象产生开销。示例代码如下：
```
public class Singleton {
 
    private static Object obj = new Object();
    private static Singleton instance = null;
 
    private Singleton(){
    }
 
    public static Singleton getInstance() {
        // if already inited, no need to get lock everytime
        if (instance == null) {
            synchronized (obj) {
                if (instance == null) {
                    instance = new Singleton();
                }
            }
        }
 
        return instance;
    }
}
```
- 缓存
1. 图片缓存：使用网络-内存-sd卡三级缓存；
2. 线程池：使用Java的Executors类，通过newCachedThreadPool、newFixedThreadPool、newSingleThreadExecutor、newScheduledThreadPool提供四种不同类型的线程池；
3. View缓存：具体可见ListView的convertView的复用；
4. IO缓存：使用具有缓存策略的输入流，BufferedInputStream替代InputStream，BufferedReader替代Reader，BufferedReader替代BufferedInputStream.对文件、网络IO皆适用。
5. 消息缓存：通过Handler的obtainMessage回收Message对象，减少Message对象的创建开销handler.sendMessage(handler.obtainMessage(1));
6. 除需要设置优先级的线程使用new Thread创建外，其余线程创建使用new Runnable。因为子类会有自己的属性创建需要更多开销。控制最大并发数量：使用Java的Executors类，通过Executors.newFixedThreadPool(nThreads)控制线程池最大线程并发。对于http请求增加timeout。

-------------------------------
本文由darling_shadow整理完成，谢谢。
 
 
