---
layout: post
title: [iOS]为什么用alloc & init
date: 2014-05-29
tag: iOS技术
---             

<h3>前言</h3>
Oc 语言在申请对象的时，需要使用两段构造的模式。一个对象的创建，需要先调用 alloc 方法，再调用 init 方法。为何与java等其他语言不同呢？

           
<h3>alloc 和 init</h3>
<h4>alloc 方法</h4>
根据苹果的 官方文档。当对象创建时，cocoa 会从应用程序的虚拟地址空间上为该对象分配足够的内存。cocoa 会遍历该对象所有的成员变量，通过成员变量的类型来计算所需占用的内存。

当我们通过 alloc 或 allocWithZone 方法创建对象时，cocoa 会返回一个未” 初使化 “过的对象。在这个过程中，cocoa 除了上面提到的申请了一块足够大的内存外，还做了以下 3 件事：

将该新对象的引用计数 (Retain Count) 设置成 1。
将该新对象的 isa 成员变量指向它的类对象。
将该新对象的所有其它成员变量的值设置成零。（根据成员变量类型，零有可能是指 nil 或 Nil 或 0.0）
isa 成员变量是在 NSObject 中定义的，所以保证 Cocoa 的所有对象都带有此成员变量。借助该变量可以实现 Cocoa 对象在运行时的自省 (Introspection) 功能。

<h4>init 方法</h4>
大部分情况下，我们都不希望所有成员变量都是零，所以 init 方法会做真正的初使化工作，让对象的成员变量的值符合我们程序逻辑中的初始化状态。例如，NSMutableString 可能就会额外再申请一块字符数组，用于动态修改字符串。

init 还有一个需要注意的问题。某些情况下，init 会造成 alloc 的原本空间不够用，而第二次分配内存空间。所以下面的写法是错的：
```
NSString * s = [NSString alloc];
[s init]; // 这儿 init 返回的地址可能会变。s 原本的指针地址可能是无效的地址。
```
为此，苹果引入了一个编程规范，让大家写的时候将 alloc 和 init 写在一行。所以上面的代码正确的写法是

```
NSString * s = [[NSString alloc] init];
```
-------------------------------
本文由darling_shadow完成，谢谢。
 
 
